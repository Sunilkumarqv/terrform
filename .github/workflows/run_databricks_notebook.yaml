
name: Run Azure Databricks Notebook (Serverless)

on:
  workflow_dispatch:

jobs:
  run-notebook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Databricks CLI & jq
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks -v
          cat > "$HOME/.databrickscfg" <<EOF
          [DEFAULT]
          host = ${DATABRICKS_HOST}
          token = ${DATABRICKS_TOKEN}
          EOF

      - name: Run Notebook Job (Serverless)
        run: |
          NB_PATH="/Workspace/Users/sunilkumarqv@gmail.com/databricks/src/databricks/retails_nb"

          cat > job.json <<JSON
          {
            "name": "GH Actions - Serverless Notebook",
            "format": "MULTI_TASK",
            "tasks": [
              {
                "task_key": "run_nb",
                "notebook_task": {
                  "notebook_path": "${NB_PATH}",
                  "source": "WORKSPACE"
                }
              }
            ]
          }
          JSON

          CREATE_OUT=$(databricks jobs create --json @job.json -o json)
          JOB_ID=$(echo "$CREATE_OUT" | jq -r '.job_id')

          RUN_OUT=$(databricks jobs run-now "$JOB_ID" -o json)
          RUN_ID=$(echo "$RUN_OUT" | jq -r '.run_id')

          while true; do
            OUT=$(databricks jobs get-run "$RUN_ID" -o json)
            STATUS=$(echo "$OUT" | jq -r '.state.life_cycle_state')
            RESULT=$(echo "$OUT" | jq -r '.state.result_state')
            URL=$(echo "$OUT" | jq -r '.run_page_url // empty')

            if [ "$STATUS" = "TERMINATED" ]; then
              echo "Run finished: $RESULT"
              [ -n "$URL" ] && echo "Run URL: $URL"
              break
            fi
            echo "Status: $STATUS"
            sleep 20
          done

          databricks jobs delete "$JOB_ID"
