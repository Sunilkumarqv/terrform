name: Run Databricks Notebook

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/databricks/**'
      - '.github/workflows/run_databricks_notebook.yaml'

jobs:
  run-notebook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install Latest Databricks CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python3 -m pip install --upgrade pip
          python3 -m pip uninstall -y databricks-cli || true
          python3 -m pip install "databricks-cli>=0.220.0"
          databricks --version

      - name: Configure CLI & Run Notebook Job
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          set -e
          export DATABRICKS_HOST=${DATABRICKS_HOST}
          export DATABRICKS_TOKEN=${DATABRICKS_TOKEN}

          echo "üîÑ Switching CLI to Jobs API v2.1..."
          databricks jobs configure --version=2.1

          echo "üöÄ Creating Databricks job using API v2.1..."
          RESPONSE=$(databricks jobs create --json-file src/databricks/job_config.json)
          echo "Response: $RESPONSE"

          JOB_ID=$(echo "$RESPONSE" | jq -r '.job_id')
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" == "null" ]; then
            echo "‚ùå Failed to create job."
            exit 1
          fi
          echo "Job ID: $JOB_ID"

          echo "‚ñ∂ Triggering job run..."
          RUN_ID=$(databricks jobs run-now --job-id $JOB_ID | jq -r '.run_id')
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "‚ùå Failed to start job run."
            exit 1
          fi
          echo "Run ID: $RUN_ID"

          echo "‚è≥ Waiting for job completion..."
          while true; do
            STATUS=$(databricks runs get --run-id $RUN_ID | jq -r '.state.life_cycle_state')
            RESULT_STATE=$(databricks runs get --run-id $RUN_ID | jq -r '.state.result_state')

            if [ "$STATUS" == "TERMINATED" ]; then
              if [ "$RESULT_STATE" == "SUCCESS" ]; then
                echo "‚úÖ Notebook completed successfully."
                exit 0
              else
                echo "‚ùå Notebook failed: $RESULT_STATE"
                exit 1
              fi
            else
              echo "Still running... Status: $STATUS"
              sleep 30
            fi
          done
