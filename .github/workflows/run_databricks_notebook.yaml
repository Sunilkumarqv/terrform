name: Run Databricks Notebook

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/databricks/**'
      - '.github/workflows/run_databricks_notebook.yaml'

jobs:
  run-notebook:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      # 3. Install Databricks CLI and jq
      - name: Install Databricks CLI and jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          python3 -m pip install --upgrade pip
          python3 -m pip install nutter
          python3 -m pip install --upgrade databricks-cli

      # 4. Configure CLI + Create & Run Notebook Job (same shell to persist API version 2.1)
      - name: Configure CLI v2.1 + Create & Run Databricks Notebook
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          set -e
          export DATABRICKS_HOST=${DATABRICKS_HOST}
          export DATABRICKS_TOKEN=${DATABRICKS_TOKEN}

          echo "üîÑ Switching Databricks CLI to Jobs API v2.1..."
          databricks jobs configure --version=2.1

          echo "üöÄ Creating Databricks job from job_config.json..."
          RESPONSE=$(databricks jobs create --json-file src/databricks/job_config.json)
          echo "API Response: $RESPONSE"

          JOB_ID=$(echo "$RESPONSE" | jq -r '.job_id')
          if [ "$JOB_ID" == "null" ] || [ -z "$JOB_ID" ]; then
            echo "‚ùå Failed to create job. See API response above."
            exit 1
          fi
          echo "‚úÖ Job created with ID: $JOB_ID"

          echo "‚ñ∂ Triggering job run..."
          RUN_ID=$(databricks jobs run-now --job-id $JOB_ID | jq -r '.run_id')
          if [ "$RUN_ID" == "null" ] || [ -z "$RUN_ID" ]; then
            echo "‚ùå Failed to start job run."
            exit 1
          fi
          echo "üìå Run ID: $RUN_ID"

          echo "‚è≥ Waiting for job completion..."
          while true; do
            STATUS=$(databricks runs get --run-id $RUN_ID | jq -r '.state.life_cycle_state')
            RESULT_STATE=$(databricks runs get --run-id $RUN_ID | jq -r '.state.result_state')

            if [ "$STATUS" == "TERMINATED" ]; then
              if [ "$RESULT_STATE" == "SUCCESS" ]; then
                echo "‚úÖ Notebook job completed successfully."
                exit 0
              else
                echo "‚ùå Notebook job failed with result state: $RESULT_STATE"
                exit 1
              fi
            else
              echo "üîÑ Current job status: $STATUS... waiting 30s"
              sleep 30
            fi
          done
